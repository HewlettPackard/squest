{% extends 'base.html' %}

{% block main %}
    {% load static %}
    {% has_perm request.user "auth.list_user" as can_list_user %}
    {% has_perm request.user "service_catalog.list_instance" as can_list_instance %}
    {% has_perm request.user "service_catalog.list_request" as can_list_request %}
    {% has_perm request.user "service_catalog.list_support" as can_list_support %}
    {% has_perm request.user "service_catalog.list_service" as can_list_service %}
    <div class="container-fluid">
        {% for announcement in announcements %}
            <div class="row">
                <div class="col-lg col">
                    <div class="alert alert-{{ announcement.type|lower }} alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
                        <h4><i class="icon {{ announcement.type|map_color_to_icon }}"></i> {{ announcement.title }}</h4>
                        {{ announcement.message | safe }}
                    </div>
                </div>
            </div>
        {% endfor %}
        <div class="row">
            {% if can_list_request %}
                <div class="mt-2 col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <div class="h-100 small-box d-flex flex-column bg-info">
                        <!-- small card -->
                        <div class="inner flex-grow-1">
                            <h3>{{ total_request }}</h3>
                            <p>New Request</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <a href="{% url 'service_catalog:request_list' %}?state=SUBMITTED"
                           class="small-box-footer">
                            More info <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>

                </div>
            {% endif %}

            {% if can_list_instance %}

                <div class="mt-2 col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <!-- small card -->
                    <div class="h-100 small-box d-flex flex-column bg-success">
                        <div class="inner flex-grow-1">
                            <h3>{{ total_instance }}</h3>
                            <p>Available instances</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-th"></i>
                        </div>
                        <a href="{% url 'service_catalog:instance_list' %}?state=AVAILABLE"
                           class="small-box-footer">
                            More info <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
            {% endif %}
            {% if can_list_support %}
                <div class="mt-2 col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <!-- small card -->
                    <div class="h-100 small-box d-flex flex-column bg-warning">
                        <div class="inner flex-grow-1">
                            <h3>{{ total_support_opened }}</h3>
                            <p>Opened support</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-medkit"></i>
                        </div>
                        <a href="{% url 'service_catalog:support_list' %}?state=OPENED"
                           class="small-box-footer">
                            More info <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
            {% endif %}
            {% if can_list_user %}
                <div class="mt-2 col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <!-- small card -->
                    <div class="h-100 small-box d-flex flex-column bg-default">
                        <div class="inner flex-grow-1">
                            <h3>{{ total_user }}</h3>
                            <p>Users</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <a href="{% url 'profiles:user_list' %}" class="small-box-footer">
                            More info <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
            {% endif %}
            {% if can_list_user %}
                <div class="mt-2 col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <!-- small card -->
                    <div class="h-100 small-box d-flex flex-column bg-pink">
                        <div class="inner flex-grow-1">
                            <h3>{{ user_without_organization }}</h3>
                            <p>Users without organization</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-users-slash"></i>
                        </div>
                        <a href="{% url 'profiles:user_list' %}?no_organization=on" class="small-box-footer">
                            More info <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
        {% if can_list_service %}
            <div class="row mt-5">
                {% for service in service_details.values %}
                    <div class="col-12 col-sm-12 col-md-6 col-lg-4 col-xl-3">

                        <div class="card card-widget widget-user-2">

                            <div class="widget-user-header bg-{% if request.user.profile.theme == "dark" %}dark{% else %}white{% endif %}">
                                <div class="widget-user-image">
                                    <img class="img elevation-2" src="


                                            {% if service.service.image %}{{ service.service.image.url }}{% else %}{% static '/squest/img/no_image.png' %}{% endif %}"
                                         alt="Illustration for {{ service.service.name }}">
                                </div>

                                <h3 class="widget-user-username">{{ service.service.name }}</h3>
                                <h5 class="widget-user-username"
                                    title="Available instances of {{ service.service.name }}"><a
                                        class="text-dark"
                                        href="{% url 'service_catalog:instance_list' %}?service={{ service.service.id }}&state=AVAILABLE">Instances
                                    available: <strong class="text-success">{{ service.instances }}</strong></a></h5>
                            </div>
                            <div class="card-footer p-0">
                                <ul class="nav flex-column">
                                    {% has_perm request.user "service_catalog.list_support" as can_list_support %}
                                    {% if can_list_support %}
                                        <li class="nav-item">
                                            <a href="{% url 'service_catalog:support_list' %}?state=OPENED&instance__service={{ service.service.id }}"
                                               class="nav-link">
                                                Opened supports<span
                                                    class="float-right badge bg-warning">{{ service.opened_supports }}</span>
                                            </a>
                                        </li>
                                    {% endif %}
                                    <li class="nav-item">
                                        <a href="{% url 'service_catalog:request_list' %}?&state=ACCEPTED&instance__service__id={{ service.service.id }}"
                                           class="nav-link">
                                            Accepted requests <span
                                                class="float-right badge bg-primary">{{ service.accepted_requests }}</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="{% url 'service_catalog:request_list' %}?&state=SUBMITTED&instance__service__id={{ service.service.id }}"
                                           class="nav-link">
                                            Submitted requests <span
                                                class="float-right badge bg-info">{{ service.submitted_requests }}</span>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="{% url 'service_catalog:request_list' %}?state=FAILED&instance__service__id={{ service.service.id }}"
                                           class="nav-link">
                                            Failed requests <span
                                                class="float-right badge bg-danger">{{ service.failed_requests }}</span>
                                        </a>
                                    </li>
                                    </li>
                                    <li class="nav-item">
                                        <a href="{% url 'service_catalog:request_list' %}?state=NEED_INFO&instance__service__id={{ service.service.id }}"
                                           class="nav-link">
                                            Need info requests <span
                                                class="float-right badge bg-warning">{{ service.need_info_requests }}</span>
                                        </a>
                                    </li>

                                </ul>
                            </div>
                        </div>

                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
{% endblock %}
